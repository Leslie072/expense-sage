# 🐳 Expense Sage - Production Deployment Guide

This guide covers deploying Expense Sage to production using Docker and Docker Compose.

## 📋 Prerequisites

- Docker 20.10+
- Docker Compose 2.0+
- 2GB+ RAM
- 10GB+ disk space
- Domain name (optional, for SSL)

## 🚀 Quick Start

### 1. Clone and Setup

```bash
git clone <your-repo-url>
cd expense_sage
chmod +x scripts/deploy.sh
```

### 2. Configure Environment

```bash
cp .env.production.example .env.production
nano .env.production  # Edit with your settings
```

### 3. Deploy

```bash
./scripts/deploy.sh
```

## 🔧 Manual Deployment

### 1. Build and Start Services

```bash
# Build the application
docker-compose build

# Start all services
docker-compose up -d

# Check status
docker-compose ps
```

### 2. Initialize Database

```bash
# The database is automatically initialized on first run
# To manually initialize:
docker-compose exec expense-sage-db /docker-entrypoint-initdb.d/init-db.sh
```

### 3. Health Check

```bash
# Check application health
curl http://localhost/health

# Check logs
docker-compose logs -f expense-sage-web
```

## 📊 Service Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Nginx Proxy   │    │  Flutter Web    │    │   SQLite DB     │
│   (Port 80/443) │────│   Application   │────│   + Backups     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │              ┌─────────────────┐              │
         └──────────────│  Backup Service │──────────────┘
                        └─────────────────┘
```

## 🔒 Security Configuration

### SSL/TLS Setup

1. **Self-signed certificates (development):**
   ```bash
   # Automatically generated by deploy script
   openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
     -keyout docker/ssl/private.key \
     -out docker/ssl/cert.pem
   ```

2. **Production certificates:**
   ```bash
   # Place your certificates in:
   docker/ssl/cert.pem      # Certificate
   docker/ssl/private.key   # Private key
   ```

### Environment Security

- Change all default passwords in `.env.production`
- Use strong JWT secrets
- Enable rate limiting
- Configure CORS properly

## 💾 Database Management

### Backup

```bash
# Manual backup
docker-compose exec expense-sage-db \
  sqlite3 /data/expense_sage.db '.backup /backup/manual_backup.db'

# Automated backups run every hour
# Location: ./docker/backup/
```

### Restore

```bash
# Stop services
docker-compose down

# Restore from backup
cp docker/backup/expense_sage_backup_YYYYMMDD_HHMMSS.db data/expense_sage.db

# Start services
docker-compose up -d
```

## 📈 Monitoring

### Application Logs

```bash
# View all logs
docker-compose logs -f

# View specific service logs
docker-compose logs -f expense-sage-web
docker-compose logs -f expense-sage-db
```

### Health Monitoring

```bash
# Application health
curl http://localhost/health

# Service status
docker-compose ps

# Resource usage
docker stats
```

### Prometheus (Optional)

```bash
# Start with monitoring
docker-compose --profile monitoring up -d

# Access Prometheus
open http://localhost:9090
```

## 🔄 Updates and Maintenance

### Update Application

```bash
# Pull latest code
git pull origin main

# Rebuild and restart
docker-compose build --no-cache
docker-compose up -d
```

### Database Migration

```bash
# Backup before migration
./scripts/backup.sh

# Run migrations (if any)
docker-compose exec expense-sage-web flutter pub run migration
```

### Clean Up

```bash
# Remove unused images
docker image prune -f

# Remove unused volumes
docker volume prune -f

# Full cleanup (careful!)
docker system prune -af
```

## 🐛 Troubleshooting

### Common Issues

1. **Port already in use:**
   ```bash
   # Check what's using port 80
   sudo lsof -i :80
   
   # Change port in docker-compose.yml
   ports:
     - "8080:80"  # Use port 8080 instead
   ```

2. **Database permission errors:**
   ```bash
   # Fix permissions
   sudo chown -R 1000:1000 data/
   chmod 644 data/expense_sage.db
   ```

3. **SSL certificate errors:**
   ```bash
   # Regenerate certificates
   rm -rf docker/ssl/*
   ./scripts/deploy.sh
   ```

### Debug Mode

```bash
# Run in debug mode
docker-compose -f docker-compose.yml -f docker-compose.debug.yml up

# Access container shell
docker-compose exec expense-sage-web sh
```

## 📞 Support

- Check logs: `docker-compose logs -f`
- Health check: `curl http://localhost/health`
- Database check: `docker-compose exec expense-sage-db sqlite3 /data/expense_sage.db ".tables"`

## 🔗 Useful Commands

```bash
# Start services
docker-compose up -d

# Stop services
docker-compose down

# Restart specific service
docker-compose restart expense-sage-web

# View logs
docker-compose logs -f

# Scale services (if needed)
docker-compose up -d --scale expense-sage-web=2

# Update and restart
git pull && docker-compose build && docker-compose up -d
```
